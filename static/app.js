// ‚îÄ‚îÄ‚îÄ DOM Elements ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const form = document.getElementById('analyze-form');
const formSection = document.getElementById('form-section');
const loadingSection = document.getElementById('loading-section');
const errorSection = document.getElementById('error-section');
const resultSection = document.getElementById('result-section');
const submitBtn = document.getElementById('submit-btn');
const btnText = document.getElementById('btn-text');
const loadingStatus = document.getElementById('loading-status');
const errorMessage = document.getElementById('error-message');
const languageSelect = document.getElementById('language');
const templateSelect = document.getElementById('template');
const projectsGrid = document.getElementById('projects-grid');

let currentLanguage = (languageSelect && languageSelect.value) || 'English';
let currentTemplate = (templateSelect && templateSelect.value) || 'modern';
let githubTokenFromEnv = false;
let apiKeyFromEnv = false;

let lastResultData = null;
const LOCAL_CONFIG_KEY = 'git2page_local_config_v1';

function wasmModeEnabled() {
    return Boolean(window.__USE_WASM__);
}

function hasWasmAnalyzer() {
    return typeof window.git2pageWasmAnalyze === 'function';
}

function isGitHubPagesHost() {
    const host = window.location.hostname || '';
    return host.endsWith('github.io');
}

function readLocalConfig() {
    try {
        const raw = localStorage.getItem(LOCAL_CONFIG_KEY);
        if (!raw) return null;
        return JSON.parse(raw);
    } catch (_) {
        return null;
    }
}

function saveLocalConfig(cfg) {
    try {
        localStorage.setItem(LOCAL_CONFIG_KEY, JSON.stringify(cfg));
    } catch (_) {
        // Ignore storage write failures (private mode, quota, etc.)
    }
}

async function waitForWasmReady(timeoutMs = 7000) {
    if (hasWasmAnalyzer()) return true;

    await new Promise((resolve) => {
        let settled = false;
        const timer = setTimeout(() => {
            if (settled) return;
            settled = true;
            resolve();
        }, timeoutMs);

        window.addEventListener('git2page:wasm-ready', () => {
            if (settled) return;
            settled = true;
            clearTimeout(timer);
            resolve();
        }, { once: true });
    });

    return hasWasmAnalyzer();
}

// ‚îÄ‚îÄ‚îÄ Localization ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const translations = {
    English: {
        formHeading: 'GitHub Profile ‚Üí Landing Page',
        formDescription: 'Turn your GitHub profile into a polished landing page powered by AI analysis.',
        labelGithubUsername: 'GitHub Username',
        placeholderGithubUsername: 'e.g., torvalds',
        labelLanguage: 'üåê Output Language',
        labelTemplate: 'üé® Template Style',
        labelGithubToken: 'GitHub Token',
        githubTokenHint: '(optional ‚Äî prevents rate limit issues)',
        placeholderGithubToken: 'ghp_... (Settings ‚Üí Developer settings ‚Üí Personal access tokens)',
        labelApiUrl: 'LLM API URL',
        placeholderApiUrl: 'e.g., https://api.openai.com/v1',
        labelApiKey: 'API Key',
        placeholderApiKey: 'sk-... (optional, leave empty for Ollama)',
        labelModelName: 'Model Name',
        placeholderModelName: 'e.g., llama3, gpt-4o-mini, mistral',
        submitButton: 'Analyze Profile',
        loadingTitle: 'Analyzing profile...',
        loadingStatusInitial: 'Fetching GitHub data...',
        loadingStatus1: 'Analyzing repositories and reading source code...',
        loadingStatus2: 'AI is crafting a detailed analysis, this may take a bit...',
        loadingStatus3: 'Still crunching code... large projects need more time.',
        loadingStatus4: 'Almost done... synthesizing insights for all projects.',
        errorTitle: 'Something went wrong',
        errorButtonText: 'Try Again',
        errorMissingUsername: 'Please enter a GitHub username.',
        errorUnknown: 'Unable to reach the server.',
        projectsTitle: 'Projects',
        profileLinkText: 'GitHub Profile',
        exportHtmlLabel: 'HTML',
        exportJsonLabel: 'JSON',
        exportCsvLabel: 'CSV',
        exportMarkdownLabel: 'Markdown',
        backButtonText: '‚Üê Start New Analysis',
        useCasesTitle: 'Use Cases',
        markdownProjectsTitle: 'Projects',
        markdownUseCases: 'Use Cases',
        markdownProblem: 'Problem',
        markdownTech: 'Tech',
        markdownGeneratedBy: 'Generated by Git2Page',
        htmlUseCases: 'Use Cases',
        htmlProfileButton: 'GitHub Profile',
        htmlProjectsHeading: 'Projects',
        htmlGeneratedBy: 'Generated by Git2Page',
        tokenLoadedPlaceholder: '‚úì Loaded from .env (you can override)',
        apiKeyLoadedPlaceholder: '‚úì Loaded from .env (you can override)'
    },
    Turkish: {
        formHeading: 'GitHub Profili ‚Üí Tanƒ±tƒ±m Sitesi',
        formDescription: 'GitHub profilinizi yapay zek√¢ analiziyle profesyonel bir vitrine d√∂n√º≈üt√ºr√ºn.',
        labelGithubUsername: 'GitHub Kullanƒ±cƒ± Adƒ±',
        placeholderGithubUsername: '√∂rn: torvalds',
        labelLanguage: 'üåê √áƒ±ktƒ± Dili',
        labelTemplate: 'üé® ≈ûablon Stili',
        labelGithubToken: 'GitHub Token',
        githubTokenHint: '(opsiyonel ‚Äî rate limit a≈üƒ±mƒ±nƒ± √∂nler)',
        placeholderGithubToken: 'ghp_... (Settings ‚Üí Developer settings ‚Üí Personal access tokens)',
        labelApiUrl: 'LLM API URL',
        placeholderApiUrl: '√∂rn: https://api.openai.com/v1',
        labelApiKey: 'API Anahtarƒ±',
        placeholderApiKey: 'sk-... (opsiyonel, Ollama i√ßin bo≈ü bƒ±rakƒ±labilir)',
        labelModelName: 'Model Adƒ±',
        placeholderModelName: '√∂rn: llama3, gpt-4o-mini, mistral',
        submitButton: 'Profili Analiz Et',
        loadingTitle: 'Profil analiz ediliyor...',
        loadingStatusInitial: 'GitHub verileri √ßekiliyor...',
        loadingStatus1: 'Repolar analiz ediliyor, kaynak kodlar okunuyor...',
        loadingStatus2: 'AI detaylƒ± analiz yapƒ±yor, bu biraz s√ºrebilir...',
        loadingStatus3: 'Kod analizi devam ediyor... B√ºy√ºk projeler daha uzun s√ºrer.',
        loadingStatus4: 'Neredeyse bitti... AI t√ºm projeleri inceliyor.',
        errorTitle: 'Bir hata olu≈ütu',
        errorButtonText: 'Tekrar Dene',
        errorMissingUsername: 'L√ºtfen GitHub kullanƒ±cƒ± adƒ±nƒ± girin.',
        errorUnknown: 'Sunucuya baƒülanƒ±lamadƒ±.',
        projectsTitle: 'Projeler',
        profileLinkText: 'GitHub Profili',
        exportHtmlLabel: 'HTML',
        exportJsonLabel: 'JSON',
        exportCsvLabel: 'CSV',
        exportMarkdownLabel: 'Markdown',
        backButtonText: '‚Üê Yeni Analiz Yap',
        useCasesTitle: 'Kullanƒ±m Senaryolarƒ±',
        markdownProjectsTitle: 'Projeler',
        markdownUseCases: 'Kullanƒ±m Senaryolarƒ±',
        markdownProblem: 'Problem',
        markdownTech: 'Teknoloji',
        markdownGeneratedBy: 'Git2Page tarafƒ±ndan olu≈üturuldu',
        htmlUseCases: 'Kullanƒ±m Senaryolarƒ±',
        htmlProfileButton: 'GitHub Profili',
        htmlProjectsHeading: 'Projeler',
        htmlGeneratedBy: 'Git2Page tarafƒ±ndan olu≈üturuldu',
        tokenLoadedPlaceholder: '‚úì .env dosyasƒ±ndan y√ºklendi (√ºzerine yazabilirsiniz)',
        apiKeyLoadedPlaceholder: '‚úì .env dosyasƒ±ndan y√ºklendi (√ºzerine yazabilirsiniz)'
    }
};

function getDictionary(lang) {
    return translations[lang] || translations.English;
}

function t(key) {
    const dict = getDictionary(currentLanguage);
    if (dict[key]) return dict[key];
    return translations.English[key] || key;
}

function applyLanguage(lang) {
    currentLanguage = translations[lang] ? lang : 'English';
    const dict = getDictionary(currentLanguage);

    const formHeading = document.getElementById('form-heading');
    const formDescription = document.getElementById('form-description');
    const githubLabel = document.getElementById('label-github-username');
    const githubInput = document.getElementById('github_username');
    const languageLabel = document.getElementById('label-language');
    const templateLabel = document.getElementById('label-template');
    const tokenLabel = document.getElementById('label-github-token');
    const tokenHint = document.getElementById('github-token-hint');
    const tokenInput = document.getElementById('github_token');
    const apiUrlLabel = document.getElementById('label-api-url');
    const apiUrlInput = document.getElementById('api_url');
    const apiKeyLabel = document.getElementById('label-api-key');
    const apiKeyInput = document.getElementById('api_key');
    const modelLabel = document.getElementById('label-model-name');
    const modelInput = document.getElementById('model_name');
    const loadingTitle = document.getElementById('loading-title');
    const errorTitle = document.getElementById('error-title');
    const errorButtonText = document.getElementById('error-button-text');
    const projectsTitle = document.getElementById('projects-title');
    const profileLinkText = document.getElementById('profile-link-text');
    const exportHtmlLabel = document.getElementById('export-html-label');
    const exportJsonLabel = document.getElementById('export-json-label');
    const exportCsvLabel = document.getElementById('export-csv-label');
    const exportMdLabel = document.getElementById('export-md-label');
    const backButtonText = document.getElementById('back-button-text');

    if (formHeading) formHeading.textContent = dict.formHeading;
    if (formDescription) formDescription.textContent = dict.formDescription;
    if (githubLabel) githubLabel.textContent = dict.labelGithubUsername;
    if (githubInput) githubInput.placeholder = dict.placeholderGithubUsername;
    if (languageLabel) languageLabel.textContent = dict.labelLanguage;
    if (templateLabel) templateLabel.textContent = dict.labelTemplate;
    if (tokenLabel) tokenLabel.childNodes[0].textContent = `${dict.labelGithubToken} `;
    if (tokenHint) tokenHint.textContent = dict.githubTokenHint;
    if (tokenInput) tokenInput.placeholder = githubTokenFromEnv ? dict.tokenLoadedPlaceholder : dict.placeholderGithubToken;
    if (apiUrlLabel) apiUrlLabel.textContent = dict.labelApiUrl;
    if (apiUrlInput) apiUrlInput.placeholder = dict.placeholderApiUrl;
    if (apiKeyLabel) apiKeyLabel.textContent = dict.labelApiKey;
    if (apiKeyInput) apiKeyInput.placeholder = apiKeyFromEnv ? dict.apiKeyLoadedPlaceholder : dict.placeholderApiKey;
    if (modelLabel) modelLabel.textContent = dict.labelModelName;
    if (modelInput) modelInput.placeholder = dict.placeholderModelName;
    if (btnText) btnText.textContent = dict.submitButton;
    if (loadingTitle) loadingTitle.textContent = dict.loadingTitle;
    if (loadingStatus) loadingStatus.textContent = dict.loadingStatusInitial;
    if (errorTitle) errorTitle.textContent = dict.errorTitle;
    if (errorButtonText) errorButtonText.textContent = dict.errorButtonText;
    if (projectsTitle) projectsTitle.textContent = dict.projectsTitle;
    if (profileLinkText) profileLinkText.textContent = dict.profileLinkText;
    if (exportHtmlLabel) exportHtmlLabel.textContent = dict.exportHtmlLabel;
    if (exportJsonLabel) exportJsonLabel.textContent = dict.exportJsonLabel;
    if (exportCsvLabel) exportCsvLabel.textContent = dict.exportCsvLabel;
    if (exportMdLabel) exportMdLabel.textContent = dict.exportMarkdownLabel;
    if (backButtonText) backButtonText.textContent = dict.backButtonText;
}

// ‚îÄ‚îÄ‚îÄ Load Config from .env ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

(async function loadConfig() {
    if (wasmModeEnabled()) {
        const cfg = readLocalConfig();
        if (cfg?.api_url) document.getElementById('api_url').value = cfg.api_url;
        if (cfg?.model_name) document.getElementById('model_name').value = cfg.model_name;
        if (cfg?.github_token) document.getElementById('github_token').value = cfg.github_token;
        if (cfg?.api_key) document.getElementById('api_key').value = cfg.api_key;
        applyLanguage(currentLanguage);
        return;
    }

    try {
        const resp = await fetch('/config');
        const cfg = await resp.json();
        if (cfg.api_url) document.getElementById('api_url').value = cfg.api_url;
        if (cfg.model) document.getElementById('model_name').value = cfg.model;
        if (cfg.has_github_token) {
            githubTokenFromEnv = true;
        }
        if (cfg.has_api_key) {
            apiKeyFromEnv = true;
        }
        applyLanguage(currentLanguage);
    } catch (_) { /* .env not configured, ignore */ }
})();

applyLanguage(currentLanguage);

if (languageSelect) {
    languageSelect.addEventListener('change', (event) => {
        applyLanguage(event.target.value);
    });
}

if (templateSelect) {
    templateSelect.addEventListener('change', (event) => {
        applyTemplate(event.target.value);
        if (lastResultData) {
            renderResult(lastResultData);
        }
    });
}

// ‚îÄ‚îÄ‚îÄ State Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function showSection(section) {
    [formSection, loadingSection, errorSection, resultSection].forEach(s => {
        s.classList.add('hidden');
    });
    section.classList.remove('hidden');
}

function applyTemplate(templateName) {
    const allowedTemplates = [
        'modern',
        'spotlight',
        'timeline',
        '8bit',
        'gothic',
        'myspace',
        'retro-terminal',
        'magazine'
    ];
    currentTemplate = allowedTemplates.includes(templateName) ? templateName : 'modern';

    const templateClasses = allowedTemplates.map(name => `template-${name}`);
    templateClasses.forEach(cls => resultSection.classList.remove(cls));
    resultSection.classList.add(`template-${currentTemplate}`);

    if (projectsGrid) {
        if (currentTemplate === 'timeline') {
            projectsGrid.className = 'grid grid-cols-1 gap-4';
        } else if (currentTemplate === 'magazine') {
            projectsGrid.className = 'grid grid-cols-1 xl:grid-cols-3 gap-5';
        } else {
            projectsGrid.className = 'grid grid-cols-1 md:grid-cols-2 gap-5';
        }
    }
}

applyTemplate(currentTemplate);

function resetToForm() {
    showSection(formSection);
    submitBtn.disabled = false;
    btnText.textContent = t('submitButton');
}

function showError(msg) {
    errorMessage.textContent = msg;
    showSection(errorSection);
}

function updateLoadingStatus(text) {
    loadingStatus.textContent = text;
}

// ‚îÄ‚îÄ‚îÄ Form Handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const githubUsername = document.getElementById('github_username').value.trim();
    const githubToken = document.getElementById('github_token').value.trim();
    const apiUrl = document.getElementById('api_url').value.trim();
    const apiKey = document.getElementById('api_key').value.trim();
    const modelName = document.getElementById('model_name').value.trim();
    const language = document.getElementById('language').value;
    const payload = {
        github_username: githubUsername,
        github_token: githubToken,
        api_url: apiUrl,
        api_key: apiKey,
        model_name: modelName,
        language,
    };

    if (!githubUsername) {
        showError(t('errorMissingUsername'));
        return;
    }

    // Show loading
    showSection(loadingSection);
    updateLoadingStatus(t('loadingStatusInitial'));

    try {
        // Simulate status updates
        const statusTimer = setTimeout(() => {
            updateLoadingStatus(t('loadingStatus1'));
        }, 3000);

        const statusTimer2 = setTimeout(() => {
            updateLoadingStatus(t('loadingStatus2'));
        }, 10000);

        const statusTimer3 = setTimeout(() => {
            updateLoadingStatus(t('loadingStatus3'));
        }, 30000);

        const statusTimer4 = setTimeout(() => {
            updateLoadingStatus(t('loadingStatus4'));
        }, 60000);

        let data;
        const shouldTryWasm = wasmModeEnabled();
        if (shouldTryWasm) {
            const wasmReady = await waitForWasmReady();
            if (!wasmReady) {
                if (isGitHubPagesHost()) {
                    throw new Error('WASM analyzer could not be initialized. Please refresh and try again.');
                }

                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });

                data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || t('errorUnknown'));
                }
            } else {
                data = await window.git2pageWasmAnalyze(payload);
            }
        } else {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || t('errorUnknown'));
            }
        }

        clearTimeout(statusTimer);
        clearTimeout(statusTimer2);
        clearTimeout(statusTimer3);
        clearTimeout(statusTimer4);

        if (wasmModeEnabled()) {
            saveLocalConfig({
                api_url: apiUrl,
                model_name: modelName,
                github_token: githubToken,
                api_key: apiKey,
            });
        }

        renderResult(data);
    } catch (err) {
        showError(err.message || t('errorUnknown'));
    }
});

// ‚îÄ‚îÄ‚îÄ Render Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderResult(data) {
    lastResultData = data;

    // Avatar
    const avatar = document.getElementById('avatar');
    avatar.src = data.avatar_url;
    avatar.alt = data.username;

    // Hero
    document.getElementById('hero-title').textContent = data.hero_title;
    document.getElementById('hero-bio').textContent = data.bio;

    // Profile link
    const profileLink = document.getElementById('profile-link');
    profileLink.href = data.profile_url;

    // Projects
    const grid = document.getElementById('projects-grid');
    grid.innerHTML = '';

    applyTemplate(currentTemplate);

    data.projects.forEach((project, index) => {
        const card = createProjectCard(project, index);
        grid.appendChild(card);
    });

    showSection(resultSection);
}

function createProjectCard(project, index) {
    const card = document.createElement('div');
    const delay = Math.min(index * 0.08, 0.8);
    const templateCardClasses = {
        modern: 'bg-white/5 border border-white/10 rounded-2xl',
        spotlight: 'border border-brand-400/40 rounded-2xl',
        timeline: 'border border-white/10 rounded-xl',
        '8bit': 'border rounded-none',
        gothic: 'border border-amber-200/30 rounded-xl',
        myspace: 'border border-cyan-300/60 rounded-2xl',
        'retro-terminal': 'border border-emerald-300/40 rounded-xl',
        magazine: 'border border-zinc-100/20 rounded-lg'
    };
    const templateClass = templateCardClasses[currentTemplate] || templateCardClasses.modern;
    card.className = `${templateClass} p-6 hover:border-brand-500/30 card-glow transition-all duration-300 fade-in-up project-card`;
    card.style.animationDelay = `${delay}s`;
    card.style.opacity = '0';

    // Stars & forks badges
    const statsHTML = `
        <div class="flex items-center gap-3 text-xs text-gray-500">
            ${project.stars > 0 ? `
                <span class="flex items-center gap-1">
                    <svg class="w-3.5 h-3.5 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    ${project.stars}
                </span>` : ''}
            ${project.forks > 0 ? `
                <span class="flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
                    </svg>
                    ${project.forks}
                </span>` : ''}
            ${project.language ? `
                <span class="flex items-center gap-1">
                    <span class="w-2 h-2 rounded-full ${getLanguageColor(project.language)}"></span>
                    ${project.language}
                </span>` : ''}
        </div>
    `;

    // Tech stack badges
    const techBadges = project.tech_stack.map(tech =>
        `<span class="px-2.5 py-1 bg-brand-500/15 text-brand-300 text-xs font-medium rounded-lg">${escapeHtml(tech)}</span>`
    ).join('');

    const timelinePrefix = currentTemplate === 'timeline'
        ? `<span class="text-xs uppercase tracking-widest text-brand-300">#${String(index + 1).padStart(2, '0')}</span>`
        : '';

    // Use cases list
    const useCasesTitle = t('useCasesTitle');
    const useCasesHTML = (project.use_cases && project.use_cases.length > 0) ? `
        <div class="mt-3 mb-3">
            <p class="text-xs font-semibold text-brand-300 uppercase tracking-wider mb-2">${escapeHtml(useCasesTitle)}</p>
            <ul class="space-y-1">
                ${project.use_cases.map(uc => `
                    <li class="flex items-start gap-2 text-xs text-gray-400">
                        <span class="text-brand-400 mt-0.5 flex-shrink-0">‚ñ∏</span>
                        <span>${escapeHtml(uc)}</span>
                    </li>
                `).join('')}
            </ul>
        </div>
    ` : '';

    card.innerHTML = `
        <div class="flex items-start justify-between mb-3 gap-3">
            <h3 class="text-lg font-bold text-white truncate">${escapeHtml(project.name)}</h3>
            ${timelinePrefix}
            <a href="${escapeHtml(project.html_url)}" target="_blank" class="text-gray-500 hover:text-brand-400 transition-colors flex-shrink-0 ml-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
            </a>
        </div>
        <p class="text-brand-200 text-sm font-medium mb-2">${escapeHtml(project.problem_solved)}</p>
        <p class="text-gray-400 text-sm leading-relaxed mb-3">${escapeHtml(project.detailed_description || '')}</p>
        ${useCasesHTML}
        <div class="flex flex-wrap gap-2 mb-3">${techBadges}</div>
        ${statsHTML}
    `;

    return card;
}

// ‚îÄ‚îÄ‚îÄ Utility Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ‚îÄ‚îÄ‚îÄ Export Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function downloadFile(filename, content, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function exportAsJSON() {
    if (!lastResultData) return;
    const json = JSON.stringify(lastResultData, null, 2);
    downloadFile(`${lastResultData.username}-git2page.json`, json, 'application/json');
}

function exportAsCSV() {
    if (!lastResultData) return;
    const headers = ['Name', 'Language', 'Stars', 'Forks', 'Problem Solved', 'Detailed Description', 'Use Cases', 'Tech Stack', 'URL'];
    const rows = lastResultData.projects.map(p => [
        p.name,
        p.language || '',
        p.stars,
        p.forks,
        `"${(p.problem_solved || '').replace(/"/g, '""')}"`,
        `"${(p.detailed_description || '').replace(/"/g, '""')}"`,
        `"${(p.use_cases || []).join('; ').replace(/"/g, '""')}"`,
        `"${(p.tech_stack || []).join(', ').replace(/"/g, '""')}"`,
        p.html_url
    ]);
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    downloadFile(`${lastResultData.username}-git2page.csv`, csv, 'text/csv');
}

function exportAsMarkdown() {
    if (!lastResultData) return;
    const d = lastResultData;
    let md = `# ${d.hero_title}\n\n`;
    md += `![Avatar](${d.avatar_url})\n\n`;
    md += `${d.bio}\n\n`;
    md += `[GitHub Profile](${d.profile_url})\n\n`;
    md += `---\n\n## ${t('markdownProjectsTitle')}\n\n`;
    d.projects.forEach(p => {
        md += `### ${p.name}\n\n`;
        if (p.problem_solved) md += `**${t('markdownProblem')}:** ${p.problem_solved}\n\n`;
        if (p.detailed_description) md += `${p.detailed_description}\n\n`;
        if (p.use_cases && p.use_cases.length > 0) {
            md += `**${t('markdownUseCases')}:**\n`;
            p.use_cases.forEach(uc => { md += `- ${uc}\n`; });
            md += `\n`;
        }
        if (p.tech_stack && p.tech_stack.length > 0) {
            md += `**${t('markdownTech')}:** ${p.tech_stack.join(', ')}\n\n`;
        }
        md += `‚≠ê ${p.stars} | üç¥ ${p.forks} | ${p.language || 'N/A'} | [Repo](${p.html_url})\n\n---\n\n`;
    });
    md += `${t('markdownGeneratedBy')}\n`;
    downloadFile(`${d.username}-git2page.md`, md, 'text/markdown');
}

function exportAsHTML() {
    if (!lastResultData) return;
    const d = lastResultData;
    const exportTheme = getExportTheme(currentTemplate);
    const projectCards = d.projects.map((p, index) => {
        const useCases = (p.use_cases && p.use_cases.length > 0)
            ? `<div style="margin-top:12px"><strong>${escapeHtml(t('htmlUseCases'))}:</strong><ul>${p.use_cases.map(uc => `<li>${escapeHtml(uc)}</li>`).join('')}</ul></div>`
            : '';
        const techBadges = (p.tech_stack || []).map(t =>
            `<span style="display:inline-block;background:${exportTheme.badgeBg};color:${exportTheme.badgeText};padding:2px 10px;border-radius:8px;font-size:12px;margin:2px">${escapeHtml(t)}</span>`
        ).join('');
        const timelineMark = currentTemplate === 'timeline' ? `<div style="font-size:11px;letter-spacing:0.08em;text-transform:uppercase;color:${exportTheme.muted};margin-bottom:10px">Entry ${index + 1}</div>` : '';
        return `
        <div style="background:${exportTheme.cardBg};border:1px solid ${exportTheme.cardBorder};border-radius:${exportTheme.cardRadius};padding:24px;margin-bottom:16px">
            ${timelineMark}
            <div style="display:flex;justify-content:space-between;align-items:center">
                <h3 style="color:#fff;margin:0;font-size:18px">${escapeHtml(p.name)}</h3>
                <a href="${escapeHtml(p.html_url)}" target="_blank" style="color:${exportTheme.link};font-size:13px">View ‚Üí</a>
            </div>
            <p style="color:${exportTheme.accent};font-size:14px;margin-top:8px;font-weight:500">${escapeHtml(p.problem_solved || '')}</p>
            <p style="color:${exportTheme.text};font-size:14px;line-height:1.6">${escapeHtml(p.detailed_description || '')}</p>
            ${useCases}
            <div style="margin-top:12px">${techBadges}</div>
            <div style="margin-top:12px;font-size:12px;color:${exportTheme.muted}">
                ‚≠ê ${p.stars} &nbsp; üç¥ ${p.forks} &nbsp; ${p.language || ''}
            </div>
        </div>`;
    }).join('');

    const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(d.username)} - Git2Page</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: ${exportTheme.fontFamily}; background: ${exportTheme.bodyBg}; color: #e5e7eb; padding: 40px 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        a { color: ${exportTheme.link}; text-decoration: none; }
        ul { padding-left: 20px; }
        li { color: ${exportTheme.text}; font-size: 13px; margin: 4px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align:center;padding:40px 0;border-bottom:1px solid #222">
            <img src="${d.avatar_url}" alt="avatar" style="width:96px;height:96px;border-radius:50%;border:3px solid #6366f150;margin-bottom:20px"/>
            <h1 style="font-size:36px;background:${exportTheme.heroGradient};-webkit-background-clip:text;-webkit-text-fill-color:transparent">${escapeHtml(d.hero_title)}</h1>
            <p style="color:${exportTheme.text};font-size:16px;max-width:600px;margin:16px auto;line-height:1.6">${escapeHtml(d.bio)}</p>
            <a href="${d.profile_url}" target="_blank" style="display:inline-block;margin-top:12px;padding:8px 20px;background:${exportTheme.buttonBg};border-radius:12px;font-size:14px">${escapeHtml(t('htmlProfileButton'))}</a>
        </div>
        <div style="padding:32px 0">
            <h2 style="font-size:24px;margin-bottom:24px;color:#fff">${escapeHtml(t('htmlProjectsHeading'))}</h2>
            ${projectCards}
        </div>
        <div style="text-align:center;padding:20px 0;border-top:1px solid #222;color:${exportTheme.muted};font-size:13px">
            ${escapeHtml(t('htmlGeneratedBy'))}
        </div>
    </div>
</body>
</html>`;

    downloadFile(`${d.username}-git2page.html`, html, 'text/html');
}

function getExportTheme(templateName) {
    const themes = {
        modern: {
            fontFamily: "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
            bodyBg: '#0f0f1a',
            cardBg: '#1e1e2e',
            cardBorder: '#333',
            cardRadius: '16px',
            text: '#9ca3af',
            muted: '#6b7280',
            accent: '#a78bfa',
            link: '#818cf8',
            badgeBg: '#6366f120',
            badgeText: '#818cf8',
            heroGradient: 'linear-gradient(to right,#fff,#818cf8)',
            buttonBg: '#ffffff15'
        },
        spotlight: {
            fontFamily: "'Space Grotesk', -apple-system, sans-serif",
            bodyBg: 'radial-gradient(circle at top, #312e81, #020617)',
            cardBg: 'rgba(49,46,129,0.35)',
            cardBorder: '#818cf8',
            cardRadius: '18px',
            text: '#c7d2fe',
            muted: '#a5b4fc',
            accent: '#f5d0fe',
            link: '#c4b5fd',
            badgeBg: '#a78bfa33',
            badgeText: '#ddd6fe',
            heroGradient: 'linear-gradient(to right,#ffffff,#c4b5fd)',
            buttonBg: '#a78bfa33'
        },
        timeline: {
            fontFamily: "'Inter', sans-serif",
            bodyBg: '#020617',
            cardBg: 'rgba(15,23,42,0.8)',
            cardBorder: '#475569',
            cardRadius: '10px',
            text: '#cbd5e1',
            muted: '#94a3b8',
            accent: '#93c5fd',
            link: '#7dd3fc',
            badgeBg: '#0ea5e933',
            badgeText: '#7dd3fc',
            heroGradient: 'linear-gradient(to right,#f8fafc,#7dd3fc)',
            buttonBg: '#0ea5e933'
        },
        '8bit': {
            fontFamily: "'Press Start 2P', monospace",
            bodyBg: '#020617',
            cardBg: '#050b0f',
            cardBorder: '#34d399',
            cardRadius: '0px',
            text: '#bbf7d0',
            muted: '#86efac',
            accent: '#fef08a',
            link: '#5eead4',
            badgeBg: '#34d39922',
            badgeText: '#6ee7b7',
            heroGradient: 'linear-gradient(to right,#f0fdf4,#5eead4)',
            buttonBg: '#34d39922'
        },
        gothic: {
            fontFamily: "'Cinzel', serif",
            bodyBg: '#0b0715',
            cardBg: 'rgba(24,12,34,0.75)',
            cardBorder: '#f59e0b',
            cardRadius: '14px',
            text: '#fde68a',
            muted: '#fcd34d',
            accent: '#fef3c7',
            link: '#fbbf24',
            badgeBg: '#f59e0b33',
            badgeText: '#fde68a',
            heroGradient: 'linear-gradient(to right,#fef9c3,#f59e0b)',
            buttonBg: '#f59e0b2e'
        },
        myspace: {
            fontFamily: "'Permanent Marker', 'Comic Sans MS', cursive",
            bodyBg: 'linear-gradient(160deg,#1d4ed8,#ec4899)',
            cardBg: 'rgba(236,72,153,0.22)',
            cardBorder: '#67e8f9',
            cardRadius: '20px',
            text: '#fce7f3',
            muted: '#cffafe',
            accent: '#f9a8d4',
            link: '#67e8f9',
            badgeBg: '#67e8f933',
            badgeText: '#cffafe',
            heroGradient: 'linear-gradient(to right,#fdf2f8,#67e8f9)',
            buttonBg: '#67e8f933'
        },
        'retro-terminal': {
            fontFamily: "'VT323', monospace",
            bodyBg: '#020b06',
            cardBg: 'rgba(3,15,9,0.85)',
            cardBorder: '#34d399',
            cardRadius: '10px',
            text: '#6ee7b7',
            muted: '#4ade80',
            accent: '#bbf7d0',
            link: '#6ee7b7',
            badgeBg: '#34d39922',
            badgeText: '#6ee7b7',
            heroGradient: 'linear-gradient(to right,#d1fae5,#34d399)',
            buttonBg: '#34d39922'
        },
        magazine: {
            fontFamily: "'Space Grotesk', -apple-system, sans-serif",
            bodyBg: '#09090b',
            cardBg: '#18181b',
            cardBorder: '#3f3f46',
            cardRadius: '10px',
            text: '#d4d4d8',
            muted: '#a1a1aa',
            accent: '#e4e4e7',
            link: '#93c5fd',
            badgeBg: '#93c5fd22',
            badgeText: '#bfdbfe',
            heroGradient: 'linear-gradient(to right,#fafafa,#93c5fd)',
            buttonBg: '#27272a'
        }
    };

    return themes[templateName] || themes.modern;
}

function getLanguageColor(language) {
    const colors = {
        'JavaScript': 'bg-yellow-400',
        'TypeScript': 'bg-blue-400',
        'Python': 'bg-green-400',
        'Rust': 'bg-orange-500',
        'Go': 'bg-cyan-400',
        'Java': 'bg-red-400',
        'C++': 'bg-pink-400',
        'C': 'bg-gray-400',
        'C#': 'bg-purple-400',
        'Ruby': 'bg-red-500',
        'PHP': 'bg-indigo-400',
        'Swift': 'bg-orange-400',
        'Kotlin': 'bg-purple-500',
        'Dart': 'bg-blue-500',
        'Shell': 'bg-green-500',
        'HTML': 'bg-orange-600',
        'CSS': 'bg-blue-600',
        'Vue': 'bg-emerald-400',
        'Svelte': 'bg-red-400',
    };
    return colors[language] || 'bg-gray-400';
}
